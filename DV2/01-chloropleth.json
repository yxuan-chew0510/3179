{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 700,
  "height": 400,
  "projection": {
    "type": "mercator",
    "center": [110.8, 4.2105],
    "scale": 1950,
    "translate": [395, 170]
  },
  "params": [
    {
      "name": "year_select",
      "value": 2021,
      "bind": {
        "input": "range",
        "min": 2011,
        "max": 2021,
        "step": 1,
        "name": "Select Year: "
      }
    }
  ],
  "datasets": {
    "state_centroids": [
      {"state": "Johor", "lon": 103.45, "lat": 1.85},
      {"state": "Kedah", "lon": 100.5, "lat": 6.1},
      {"state": "Kelantan", "lon": 102.3, "lat": 5.3},
      {"state": "Melaka", "lon": 102.25, "lat": 2.25},
      {"state": "Negeri Sembilan", "lon": 102.15, "lat": 2.8},
      {"state": "Pahang", "lon": 102.5, "lat": 3.8},
      {"state": "Penang", "lon": 100.27, "lat": 5.35},
      {"state": "Perak", "lon": 101.05, "lat": 4.8},
      {"state": "Perlis", "lon": 100.25, "lat": 6.6},
      {"state": "Sabah", "lon": 117.0, "lat": 5.5},
      {"state": "Sarawak", "lon": 110.5, "lat": 1.0},
      {"state": "Selangor", "lon": 101.5, "lat": 3.05},
      {"state": "Terengganu", "lon": 103.0, "lat": 5.0},
      {"state": "Kuala Lumpur", "lon": 101.7, "lat": 3.13},
      {"state": "Putrajaya", "lon": 101.68, "lat": 2.93},
      {"state": "Labuan", "lon": 115.2, "lat": 5.3}
    ]
  },

  "layer": [
    { "data": {"sphere": true}, "mark": {"type": "geoshape", "fill": "#ecf6ff"} },
    { "data": {"graticule": {"step": [2, 2]}}, "mark": {"type": "geoshape", "stroke": "lightgrey", "strokeWidth": 0.8} },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/yxuan-chew0510/3179/refs/heads/main/DV2/dataset/edu_lfs_merged.csv"
      },
      "transform": [
        {"filter": "datum.education_level == 'Tertiary'"},
        {"filter": "toNumber(datum.year) == year_select"},
        {"calculate": "datum.percentage * 100", "as": "percentage_display"},
        {
          "lookup": "state",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/yxuan-chew0510/3179/refs/heads/main/DV2/dataset/malaysia_states.json",
              "format": {"type": "topojson", "feature": "malaysia_states"}
            },
            "key": "properties.name_en"
          },
          "as": "geo"
        }
      ],
      "mark": {"type": "geoshape", "stroke": "dimgrey"},
      "encoding": {
        "shape": {"field": "geo", "type": "geojson"},
        "color": {
          "field": "percentage_display",
          "type": "quantitative",
          "title": "% Tertiary Education",
          "scale": {"scheme": "greenblue"},
          "legend": {"gradientLength": 300, "orient": "bottom-right"}
        },
        "tooltip": [
          {"field": "state", "title": "State"},
          {"field": "percentage_display", "title": "Tertiary Education (%)", "format": ".1f"}
        ]
      }
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/yxuan-chew0510/3179/refs/heads/main/DV2/dataset/edu_lfs_merged.csv"
      },
      "transform": [
        {"filter": "datum.education_level == 'Tertiary'"},
        {"filter": "toNumber(datum.year) == year_select"},
        {"calculate": "datum.percentage * 100", "as": "percentage_display"},
        {"window": [{"op": "rank", "as": "rank_desc"}], "sort": [{"field": "percentage_display", "order": "descending"}]},
        {"filter": "datum.rank_desc == 1"},
        {
          "lookup": "state",
          "from": {"data": {"name": "state_centroids"}, "key": "state", "fields": ["lon", "lat"]},
          "as": ["Longitude", "Latitude"]
        },
        {
          "calculate": "'Highest: ' + datum.state + ' (' + format(datum.percentage_display, '.1f') + '%)'",
          "as": "label_text"
        }
      ],
      "layer": [
        {
          "mark": {"type": "point", "color": "#d66d27", "size": 80, "filled": true},
          "encoding": {"longitude": {"field": "Longitude"}, "latitude": {"field": "Latitude"}}
        },
        {
          "mark": {"type": "rule", "color": "#d66d27", "strokeWidth": 2},
          "encoding": {
            "longitude": {"field": "Longitude"},
            "latitude": {"field": "Latitude"},
            "longitude2": {"field": "Longitude", "offset": 25},
            "latitude2": {"field": "Latitude", "offset": -15}
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "left",
            "dx": 30,
            "dy": -15,
            "fontWeight": "bold",
            "fontSize": 12,
            "color": "#d66d27"
          },
          "encoding": {
            "longitude": {"field": "Longitude"},
            "latitude": {"field": "Latitude"},
            "text": {"field": "label_text"}
          }
        }
      ]
    },

    {
      "data": {
        "url": "https://raw.githubusercontent.com/yxuan-chew0510/3179/refs/heads/main/DV2/dataset/edu_lfs_merged.csv"
      },
      "transform": [
        {"filter": "datum.education_level == 'Tertiary'"},
        {"filter": "toNumber(datum.year) == year_select"},
        {"calculate": "datum.percentage * 100", "as": "percentage_display"},
        {"window": [{"op": "rank", "as": "rank_asc"}], "sort": [{"field": "percentage_display", "order": "ascending"}]},
        {"filter": "datum.rank_asc == 1"},
        {
          "lookup": "state",
          "from": {"data": {"name": "state_centroids"}, "key": "state", "fields": ["lon", "lat"]},
          "as": ["Longitude", "Latitude"]
        },
        {
          "calculate": "'Lowest: ' + datum.state + ' (' + format(datum.percentage_display, '.1f') + '%)'",
          "as": "label_text"
        }
      ],
      "layer": [
        {
          "mark": {"type": "point", "color": "#004aad", "size": 80, "filled": true},
          "encoding": {"longitude": {"field": "Longitude"}, "latitude": {"field": "Latitude"}}
        },
        {
          "mark": {"type": "rule", "color": "#004aad", "strokeWidth": 2},
          "encoding": {
            "longitude": {"field": "Longitude"},
            "latitude": {"field": "Latitude"},
            "longitude2": {"field": "Longitude", "offset": 25},
            "latitude2": {"field": "Latitude", "offset": 15}
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "left",
            "dx": -48,
            "dy": 60,
            "fontWeight": "bold",
            "fontSize": 12,
            "color": "#004aad"
          },
          "encoding": {
            "longitude": {"field": "Longitude"},
            "latitude": {"field": "Latitude"},
            "text": {"field": "label_text"}
          }
        }
      ]
    }
  ]
}
